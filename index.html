<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FamilyPhone â€“ Kid Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617 60%);
      color: #e5e7eb;
      overflow: hidden;
    }
    .app {
      height: 100vh;
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
    }
    header {
      padding: 8px 4px 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-shrink: 0;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header small {
      display: block;
      font-size: 11px;
      opacity: 0.7;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-primary {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }
    .btn-secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #1f2937;
      color: #e5e7eb;
    }
    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.4);
      margin-top: 12px;
      flex-shrink: 0;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      opacity: 0.8;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      margin-bottom: 10px;
    }
    input:focus, select:focus {
      outline: 2px solid #22c55e55;
      outline-offset: 1px;
    }
    .muted {
      font-size: 12px;
      opacity: 0.7;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chat-shell {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 8px;
      min-height: 0;
    }
    .chat-header {
      padding: 6px 10px;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.8);
      border-radius: 999px;
      margin-bottom: 8px;
      flex-shrink: 0;
    }
    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
      color: #022c22;
      margin-right: 8px;
    }
    .chat-header-left span {
      display: block;
      font-size: 11px;
      opacity: 0.7;
    }
    .chat-log {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 8px 4px;
      border-radius: 16px;
      background: radial-gradient(circle at top left, #020617, #020617 30%, #020617 100%);
      border: 1px solid #020617;
      max-height: 60vh;
    }
    .bubble-row {
      display: flex;
      margin-bottom: 6px;
      padding: 0 4px;
    }
    .bubble {
      max-width: 80%;
      padding: 8px 11px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.3;
      word-wrap: break-word;
    }
    .bubble-kid {
      margin-left: auto;
      background: #22c55e;
      color: #022c22;
      border-bottom-right-radius: 4px;
    }
    .bubble-parent {
      margin-right: auto;
      background: #0f172a;
      border-bottom-left-radius: 4px;
    }
    .bubble-meta {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 2px;
      text-align: right;
    }
    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      flex-shrink: 0;
    }
    .chat-input-row input {
      margin-bottom: 0;
      border-radius: 999px;
    }
    .chat-input-row button {
      white-space: nowrap;
      padding-inline: 16px;
    }
    .hidden {
      display: none !important;
    }

    /* QR scanner overlay */
    .scanner-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .scanner-backdrop.show {
      display: flex;
    }
    .scanner-card {
      background: #020617;
      border-radius: 20px;
      padding: 16px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 24px 60px rgba(0,0,0,0.6);
      text-align: center;
      border: 1px solid #1f2937;
    }
    .scanner-card h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
    }
    .scanner-card p {
      margin: 0 0 10px 0;
      font-size: 12px;
      color: #9ca3af;
    }
    #scanner-video {
      width: 100%;
      border-radius: 16px;
      margin-top: 8px;
      background: #000;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>FamilyPhone</h1>
        <small id="kid-header-sub">Sign in to start chatting</small>
      </div>
      <button id="sign-out-btn" class="btn-secondary hidden">Sign out</button>
    </header>

    <!-- AUTH CARD -->
    <section id="auth-card" class="card">
      <h2 style="margin-top:0; font-size:16px;">Grown-up sign-in</h2>
      <p class="muted">
        A parent signs in once on this device. Then weâ€™ll lock it to one child.
      </p>
      <label for="auth-email">Email</label>
      <input id="auth-email" type="email" placeholder="parent@email.com" />
      <label for="auth-password">Password</label>
      <input id="auth-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      <button id="auth-sign-in-btn" class="btn-primary" style="width:100%; margin-top:4px;">
        Sign in
      </button>
      <p id="auth-status" class="muted" style="margin-top:6px;"></p>
    </section>

    <!-- KID SELECT / QR SETUP CARD -->
    <section id="kid-select-card" class="card hidden">
      <h2 style="margin-top:0; font-size:16px;">Who is this phone for?</h2>
      <p class="muted">
        This step is for parents only. Choose the child this device belongs to, or scan the QR from the parent app.
      </p>
      <label for="kid-select">Choose child</label>
      <select id="kid-select"></select>
      <div class="row" style="margin-bottom:8px;">
        <button id="kid-confirm-btn" class="btn-primary" style="flex:1;">Set this child</button>
        <button id="scan-qr-btn" class="btn-secondary" style="flex:1;">Scan QR instead</button>
      </div>
      <p class="muted" style="margin-top:4px;">
        After this, this device will be locked to this child.
      </p>
    </section>

    <!-- CHAT AREA -->
    <section id="chat-section" class="chat-shell hidden">
      <div class="chat-header">
        <div class="chat-header-left">
          <div class="avatar" id="kid-avatar">K</div>
          <div>
            <div id="kid-name-label" style="font-size:13px; font-weight:600;">Kid</div>
            <span>Family chat only</span>
          </div>
        </div>
      </div>
      <div id="chat-log" class="chat-log">
        <p class="muted">No messages yet. Say hi ðŸ‘‹</p>
      </div>
      <form id="chat-form" class="chat-input-row">
        <button type="button" id="kid-attach-btn" class="btn-secondary">ðŸ“·</button>
        <input
          id="chat-input"
          type="text"
          autocomplete="off"
          placeholder="Type a messageâ€¦"
        />
        <input
          type="file"
          id="kid-image-input"
          accept="image/*"
          class="hidden"
        />
        <button type="submit" class="btn-primary">Send</button>
      </form>
      <p id="kid-image-status" class="muted" style="margin-top:4px; min-height:1em;"></p>
    </section>
  </div>

  <!-- QR SCANNER OVERLAY -->
  <div id="scanner-overlay" class="scanner-backdrop">
    <div class="scanner-card">
      <h3>Scan QR from parent app</h3>
      <p>Point the camera at the QR code on the parentâ€™s phone.</p>
      <video id="scanner-video" autoplay playsinline></video>
      <p id="scanner-status" class="muted" style="margin-top:6px;">Looking for QRâ€¦</p>
      <div class="row" style="margin-top:10px; justify-content:flex-end;">
        <button id="scanner-cancel" class="btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Supabase + jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://jllzjhebldumlcqofxpl.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbHpqaGVibGR1bWxjcW9meHBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MzQwMTUsImV4cCI6MjA3OTQxMDAxNX0.2K1HpiUJumjX7gRMNbG5jCMo_C2-EeHNhIL8aUgVE1g";

    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const signOutBtn = document.getElementById("sign-out-btn");
    const kidHeaderSub = document.getElementById("kid-header-sub");

    const authCard = document.getElementById("auth-card");
    const authEmail = document.getElementById("auth-email");
    const authPassword = document.getElementById("auth-password");
    const authSignInBtn = document.getElementById("auth-sign-in-btn");
    const authStatus = document.getElementById("auth-status");

    const kidSelectCard = document.getElementById("kid-select-card");
    const kidSelect = document.getElementById("kid-select");
    const kidConfirmBtn = document.getElementById("kid-confirm-btn");
    const scanQrBtn = document.getElementById("scan-qr-btn");

    const chatSection = document.getElementById("chat-section");
    const kidAvatar = document.getElementById("kid-avatar");
    const kidNameLabel = document.getElementById("kid-name-label");
    const chatLog = document.getElementById("chat-log");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");
    const kidAttachBtn = document.getElementById("kid-attach-btn");
    const kidImageInput = document.getElementById("kid-image-input");
    const kidImageStatus = document.getElementById("kid-image-status");

    const scannerOverlay = document.getElementById("scanner-overlay");
    const scannerVideo = document.getElementById("scanner-video");
    const scannerStatus = document.getElementById("scanner-status");
    const scannerCancel = document.getElementById("scanner-cancel");

    let currentUser = null;
    let currentFamily = null;
    let currentKid = null;
    let pollId = null;

    let allKids = [];
    let allMembers = [];
    let membersByUserId = {};
    let lastMessages = [];

    let scannerStream = null;
    let scannerLoopId = null;

    function show(el) { el.classList.remove("hidden"); }
    function hide(el) { el.classList.add("hidden"); }

    function initialsFromName(name) {
      if (!name) return "K";
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0][0]?.toUpperCase() || "K";
      return (parts[0][0] + parts[1][0]).toUpperCase();
    }

    function renderMessages(msgs) {
      if (!msgs || msgs.length === 0) {
        chatLog.innerHTML = '<p class="muted">No messages yet. Say hi ðŸ‘‹</p>';
        return;
      }

      const kidsMap = allKids.reduce((map, k) => {
        map[k.id] = k;
        return map;
      }, {});

      const html = msgs
        .map((m) => {
          const mine =
            m.sender_type === "kid" && m.sender_kid_id === currentKid?.id;

          let senderName = "Family";

          if (mine) {
            senderName = "You";
          } else if (m.sender_type === "kid") {
            const kid = kidsMap[m.sender_kid_id];
            senderName = kid ? kid.display_name : "Kid";
          } else if (m.sender_type === "parent") {
            const member = membersByUserId[m.sender_user_id] || null;
            const displayName = member?.display_name?.trim();
            senderName = displayName || "Parent";
          }

          const cls = mine ? "bubble bubble-kid" : "bubble bubble-parent";
          const time = new Date(m.created_at).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          let content = "";
          if (m.text) {
            content += `<div>${m.text}</div>`;
          }
          if (m.image_public_url) {
            content += `
              <div style="margin-top:4px;">
                <img
                  src="${m.image_public_url}"
                  alt="Photo"
                  style="max-width:180px; border-radius:12px; display:block;"
                />
              </div>
            `;
          }
          if (!content) {
            content = "<div>(empty)</div>";
          }

          return `
            <div class="bubble-row">
              <div class="${cls}">
                ${content}
                <div class="bubble-meta">${senderName} â€¢ ${time}</div>
              </div>
            </div>
          `;
        })
        .join("");

      chatLog.innerHTML = html;
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    async function loadMessagesOnce() {
      if (!currentFamily) return;
      const { data, error } = await client
        .from("messages")
        .select("*")
        .eq("family_id", currentFamily.id)
        .order("created_at", { ascending: true });

      if (error) {
        console.error("load messages error", error);
        return;
      }

      lastMessages = (data || []).map((m) => {
        if (m.image_url) {
          const { data: publicData } = client
            .storage
            .from("chat_uploads")
            .getPublicUrl(m.image_url);
          return { ...m, image_public_url: publicData.publicUrl };
        }
        return m;
      });

      renderMessages(lastMessages);
    }

    async function loadMembers() {
      if (!currentFamily || !currentUser) return;
      const { data, error } = await client
        .from("family_members")
        .select("family_id, user_id, role, display_name")
        .eq("family_id", currentFamily.id);

      if (error) {
        console.error("family_members error (kid app)", error);
        return;
      }

      allMembers = data || [];
      membersByUserId = allMembers.reduce((map, m) => {
        map[m.user_id] = m;
        return map;
      }, {});
    }

    async function loadSession() {
      const { data, error } = await client.auth.getSession();
      if (error) {
        console.error("getSession error", error);
        return;
      }
      if (data.session?.user) {
        currentUser = data.session.user;
        signOutBtn.classList.remove("hidden");
        kidHeaderSub.textContent = "Signed in as " + (currentUser.email || "parent");
        await afterLogin();
      } else {
        currentUser = null;
        signOutBtn.classList.add("hidden");
      }
    }

    async function afterLogin() {
      hide(authCard);
      kidHeaderSub.textContent = "Loading familyâ€¦";

      const { data: families, error: famErr } = await client
        .from("families")
        .select("*")
        .order("created_at", { ascending: true });

      if (famErr) {
        console.error("families error", famErr);
        kidHeaderSub.textContent = "Error loading family";
        return;
      }
      if (!families || families.length === 0) {
        kidHeaderSub.textContent = "No family yet â€“ set one up in parent app.";
        return;
      }
      currentFamily = families[0];
      kidHeaderSub.textContent = currentFamily.name;

      const { data: kids, error: kidsErr } = await client
        .from("kids")
        .select("*")
        .eq("family_id", currentFamily.id)
        .order("created_at", { ascending: true });

      if (kidsErr) {
        console.error("kids error", kidsErr);
        return;
      }
      if (!kids || kids.length === 0) {
        kidHeaderSub.textContent = "No kids added yet â€“ add them in parent app.";
        return;
      }

      allKids = kids;
      kidSelect.innerHTML = kids
        .map((k) => `<option value="${k.id}">${k.display_name}</option>`)
        .join("");

      await loadMembers();

      const storedKidId = localStorage.getItem("familyphone_kid_id");
      const storedKidName = localStorage.getItem("familyphone_kid_name");
      if (storedKidId && kids.find((k) => k.id === storedKidId)) {
        currentKid = { id: storedKidId, display_name: storedKidName };
        setupForKid(currentKid);
      } else {
        show(kidSelectCard);
      }
    }

    function setupForKid(kid) {
      currentKid = kid;
      localStorage.setItem("familyphone_kid_id", kid.id);
      localStorage.setItem("familyphone_kid_name", kid.display_name);
      kidAvatar.textContent = initialsFromName(kid.display_name);
      kidNameLabel.textContent = kid.display_name;
      hide(kidSelectCard);
      show(chatSection);

      if (pollId) clearInterval(pollId);
      loadMessagesOnce();
      pollId = setInterval(loadMessagesOnce, 3000);
    }

    // ==== QR SCANNER LOGIC ====
    async function startScanner() {
      try {
        scannerStatus.textContent = "Requesting cameraâ€¦";
        scannerOverlay.classList.add("show");
        scannerStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
        });
        scannerVideo.srcObject = scannerStream;
        scannerVideo.play();
        scannerStatus.textContent = "Looking for QRâ€¦";
        startScannerLoop();
      } catch (err) {
        console.error("Camera error", err);
        scannerStatus.textContent = "Could not access camera.";
      }
    }

    function stopScanner() {
      if (scannerLoopId) {
        cancelAnimationFrame(scannerLoopId);
        scannerLoopId = null;
      }
      if (scannerStream) {
        scannerStream.getTracks().forEach((t) => t.stop());
        scannerStream = null;
      }
      scannerOverlay.classList.remove("show");
    }

    function startScannerLoop() {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const loop = () => {
        if (!scannerVideo.videoWidth || !scannerVideo.videoHeight) {
          scannerLoopId = requestAnimationFrame(loop);
          return;
        }

        canvas.width = scannerVideo.videoWidth;
        canvas.height = scannerVideo.videoHeight;
        ctx.drawImage(scannerVideo, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        const code = jsQR(imageData.data, canvas.width, canvas.height, {
          inversionAttempts: "dontInvert",
        });

        if (code && code.data) {
          handleQrData(code.data);
          stopScanner();
          return;
        }

        scannerLoopId = requestAnimationFrame(loop);
      };

      loop();
    }

    function handleQrData(data) {
      try {
        const payload = JSON.parse(data);
        if (payload.t !== "familyphone_kid_link") {
          scannerStatus.textContent = "Not a FamilyPhone QR.";
          return;
        }
        if (!currentFamily || currentFamily.id !== payload.family_id) {
          alert("This QR belongs to a different family.");
          return;
        }
        const kid = allKids.find((k) => k.id === payload.kid_id);
        if (!kid) {
          alert("That child is not in this family.");
          return;
        }
        setupForKid({ id: kid.id, display_name: kid.display_name });
      } catch (err) {
        console.error("QR parse error", err);
        scannerStatus.textContent = "Could not read QR.";
      }
    }

    // ---- Event handlers ----
    authSignInBtn.addEventListener("click", async () => {
      authStatus.textContent = "";
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      if (!email || !password) {
        authStatus.textContent = "Email and password required.";
        return;
      }
      authSignInBtn.disabled = true;
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) {
        console.error("Sign in error", error);
        authStatus.textContent = "Sign in failed: " + error.message;
      } else {
        authStatus.textContent = "Signed in!";
        await loadSession();
      }
      authSignInBtn.disabled = false;
    });

    signOutBtn.addEventListener("click", async () => {
      await client.auth.signOut();
      currentUser = null;
      currentFamily = null;
      currentKid = null;
      allKids = [];
      allMembers = [];
      membersByUserId = {};
      localStorage.removeItem("familyphone_kid_id");
      localStorage.removeItem("familyphone_kid_name");
      if (pollId) clearInterval(pollId);
      hide(chatSection);
      hide(kidSelectCard);
      show(authCard);
      kidHeaderSub.textContent = "Sign in to start chatting";
    });

    kidConfirmBtn.addEventListener("click", () => {
      const kidId = kidSelect.value;
      const kidName = kidSelect.options[kidSelect.selectedIndex]?.text || "Kid";
      if (!kidId) return;
      setupForKid({ id: kidId, display_name: kidName });
    });

    scanQrBtn.addEventListener("click", () => {
      startScanner();
    });

    scannerCancel.addEventListener("click", () => {
      stopScanner();
    });

    kidAttachBtn.addEventListener("click", () => {
      kidImageInput.click();
    });

    kidImageInput.addEventListener("change", () => {
      if (kidImageInput.files[0]) {
        kidImageStatus.textContent = "Photo attached â€“ tap Send to post it.";
      } else {
        kidImageStatus.textContent = "";
      }
    });

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentFamily || !currentKid || !currentUser) return;

      const text = chatInput.value.trim();
      const file = kidImageInput.files[0];

      if (!text && !file) return;

      chatInput.disabled = true;
      kidImageStatus.textContent = file ? "Uploading photoâ€¦" : "Sendingâ€¦";

      try {
        let imagePath = null;

        if (file) {
          const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
          const fileName =
            currentFamily.id +
            "/" +
            Date.now() +
            "-" +
            Math.random().toString(36).slice(2) +
            "." +
            ext;

          const { error: uploadError } = await client
            .storage
            .from("chat_uploads")
            .upload(fileName, file);

          if (uploadError) {
            console.error("upload error", uploadError);
            alert("Error uploading image.");
            kidImageStatus.textContent = "Error uploading image.";
            chatInput.disabled = false;
            return;
          }

          imagePath = fileName;
        }

        const { error } = await client.from("messages").insert({
          family_id: currentFamily.id,
          sender_type: "kid",
          sender_kid_id: currentKid.id,
          sender_user_id: currentUser.id,
          text: text || null,
          has_attachments: !!imagePath,
          image_url: imagePath,
        });

        if (error) {
          throw error;
        }

        chatInput.value = "";
        kidImageInput.value = "";
        kidImageStatus.textContent = "";
      } catch (err) {
        console.error("send message error", err);
        alert("Error sending message â€“ check console");
        kidImageStatus.textContent = "Error sending message.";
      } finally {
        chatInput.disabled = false;
      }
    });

    // ---- Init ----
    loadSession();
  </script>
</body>
</html>
